## 第四章 组件设计

本系统的组件包括实体、管理管理员登录权限验证控制器、前台用户登录权限验证控制器、验证码、统一异常处理以及工具类。

### 4.1 实体

在com.example.networkdisk.entity包中创建AUser、BUser、SystemLog、UserFile四个实体，分别是管理员、用户、系统日志、用户文件。

AUser的代码如下：

```java
package com.example.networkdisk.entity;

import org.hibernate.validator.constraints.Length;

import javax.validation.constraints.NotBlank;

/**
 * 管理员实体类
 */
public class AUser {
    private String name;
    @NotBlank(message = "管理员ID必须输入！")
    @Length(min = 3, max = 3, message = "管理员ID是三位数！")
    private String id;
    @NotBlank(message = "密码必须输入！")
    @Length(min = 6, max = 20, message = "密码长度在6到20之间！")
    private String pwd;
    @NotBlank(message = "验证码必须输入！")
    private String validateCode;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getPwd() {
        return pwd;
    }

    public void setPwd(String pwd) {
        this.pwd = pwd;
    }

    public String getValidateCode() {
        return validateCode;
    }

    public void setValidateCode(String validateCode) {
        this.validateCode = validateCode;
    }
}

```

BUser的代码如下：

```java
package com.example.networkdisk.entity;

import org.hibernate.validator.constraints.Length;

import javax.validation.constraints.Email;
import javax.validation.constraints.NotBlank;

/**
 * 用户实例类
 */
public class BUser {
    private String id;
    @NotBlank(message = "邮箱必须输入！")
    @Email(message = "邮箱格式不正确！")
    private String email;
    @NotBlank(message = "密码必须输入！")
    @Length(min = 6, max = 20, message = "密码长度在6到20之间！")
    private String pwd;
    @NotBlank(message = "验证码必须输入！")
    private String validateCode;
    private String name;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPwd() {
        return pwd;
    }

    public void setPwd(String pwd) {
        this.pwd = pwd;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getValidateCode() {
        return validateCode;
    }

    public void setValidateCode(String validateCode) {
        this.validateCode = validateCode;
    }
}

```

SystemLog的代码如下：

```java
package com.example.networkdisk.entity;

import java.util.Date;

/**
 * 系统日志实体类
 */
public class SystemLog {
    private Date time;
    private String id;
    private String event;

    public Date getTime() {
        return time;
    }

    public void setTime(Date time) {
        this.time = time;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getEvent() {
        return event;
    }

    public void setEvent(String event) {
        this.event = event;
    }
}

```

UserFile的代码如下：

```java
package com.example.networkdisk.entity;

import java.util.Date;

/**
 * 用户文件类
 */
public class UserFile {
    private String fileid;
    private String parentid;
    private String name;
    private Date time;
    private String style;
    private String size;
    private byte[] file;

    public String getFileid() {
        return fileid;
    }

    public void setFileid(String fileid) {
        this.fileid = fileid;
    }

    public String getParentid() {
        return parentid;
    }

    public void setParentid(String parentid) {
        this.parentid = parentid;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Date getTime() {
        return time;
    }

    public void setTime(Date time) {
        this.time = time;
    }

    public String getStyle() {
        return style;
    }

    public void setStyle(String style) {
        this.style = style;
    }

    public String getSize() {
        return size;
    }

    public void setSize(String size) {
        this.size = size;
    }

    public byte[] getFile() {
        return file;
    }

    public void setFile(byte[] file) {
        this.file = file;
    }
}

```



### 4.2 管理员登录权限验证

在com.example.networkdisk.controller.adminController包中创建adminBaseController控制器类，该类中有一个@ModelAttribute注解的方法isLogin。isLogin方法的功能是判断后台管理员是否已经登录成功。需要进行后头管理员登录权限控制的控制器类继承adminBaseController类即可，因为带有@ModelAttribute注解的方法首先被控制器执行。adminBaseController控制器类的代码如下：

```java
package com.example.networkdisk.controller.adminController;

import com.example.networkdisk.exception.NoLoginException;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;

import javax.servlet.http.HttpSession;

/**
 * 管理员登录权限控制类
 */
@Controller
public class AdminBaseController {
    /**
     * 处理方法执行前执行该方法
     * NoLoginException：用于处理没有登录的异常
     */
    // @ModelAttribute： 注册一个非请求处理方法，继承该类的类在请求处理方法被调用前会先执行被注释的方法，类似于拦截器或过滤器
    @ModelAttribute
    public void isLogin(HttpSession session) throws NoLoginException {
        if (session.getAttribute("aUser") == null) {
            throw new NoLoginException("没有登录");
        }
    }
}

```

### 4.3 前台用户登录权限验证

在com.example.networkdisk.controller.userController包中创建userBaseController控制器类，该类中有一个@ModelAttribute注解的方法isLogin。isLogin方法的功能是判断前台用户是否已经登录成功。需要进行前台用户登录权限控制的控制器类继承userBaseController类即可。userBaseController控制器类的代码如下：

```java
package com.example.networkdisk.controller.userController;

import com.example.networkdisk.exception.NoLoginException;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;

import javax.servlet.http.HttpSession;

/**
 * 用户登录权限控制类
 */
@Controller
public class UserBaseController {
    /**
     * 登录权限控制类，处理方法执行前执行该方法
     * NoLoginException：用于处理没有登录的异常
     */
    // @ModelAttribute： 注册一个非请求处理方法，继承该类的类在请求处理方法被调用前会先执行被注释的方法，类似于拦截器或过滤器
    @ModelAttribute
    public void isLogin(HttpSession session) throws NoLoginException {
        if (session.getAttribute("bUser") == null) {
            throw new NoLoginException("没有登录");
        }
    }
}

```

### 4.4 验证码

本系统验证码的使用步骤如下。

1. **创建产生验证码的控制器类**

在com.example.networkdisk.controller.user包中，创建产生验证码的控制器类ValidateCodeController，具体代码如下：

  ```java
  package com.example.networkdisk.controller.userController;
  
  import org.springframework.stereotype.Controller;
  import org.springframework.web.bind.annotation.RequestMapping;
  
  import javax.imageio.ImageIO;
  import javax.servlet.http.HttpServletRequest;
  import javax.servlet.http.HttpServletResponse;
  import javax.servlet.http.HttpSession;
  import java.awt.*;
  import java.awt.image.BufferedImage;
  import java.io.IOException;
  import java.io.OutputStream;
  import java.util.Random;
  
  /**
   * 产生验证码的控制器类
   */
  @Controller
  public class ValidateCodeController {
      private final char[] code = {'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j',
              'k', 'm', 'n', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y',
              'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M',
              'N', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '2',
              '3', '4', '5', '6', '7', '8', '9'};
      private static final int WIDTH = 50;
      private static final int HEIGHT = 20;
      private static final int LENGTH = 4;
  
      @RequestMapping("/validateCode")
      public void validateCode(HttpServletRequest request,
                               HttpServletResponse response) {
          // TODO Auto-generated method stub
          // 设置响应报头信息
          response.setHeader("Pragma", "No-cache");
          response.setHeader("Cache-Control", "no-cache");
          response.setDateHeader("Expires", 0);
          // 设置响应的MIME类型
          response.setContentType("image/jpeg");
  
          BufferedImage image = new BufferedImage(WIDTH, HEIGHT,
                  BufferedImage.TYPE_INT_RGB);
          Font mFont = new Font("Arial", Font.BOLD, 18);
          Graphics g = image.getGraphics();
          Random rd = new Random();
  
          // 设置背景颜色
          g.setColor(new Color(rd.nextInt(55) + 200, rd.nextInt(55) + 200, rd
                  .nextInt(55) + 200));
          g.fillRect(0, 0, WIDTH, HEIGHT);
  
          // 设置字体
          g.setFont(mFont);
  
          // 画边框
          g.setColor(Color.black);
          g.drawRect(0, 0, WIDTH - 1, HEIGHT - 1);
  
          // 随机产生的验证码
          StringBuilder result = new StringBuilder();
          for (int i = 0; i < LENGTH; ++i) {
              result.append(code[rd.nextInt(code.length)]);
          }
          HttpSession se = request.getSession();
          // 将产生的验证码存入session中
          se.setAttribute("validateCode", result.toString());
  
          // 画验证码
          for (int i = 0; i < result.length(); i++) {
              g.setColor(new Color(rd.nextInt(200), rd.nextInt(200), rd
                      .nextInt(200)));
              g.drawString(result.charAt(i) + "", 12 * i + 1, 16);
          }
  
          // 随机产生2个干扰线
          for (int i = 0; i < 2; i++) {
              g.setColor(new Color(rd.nextInt(200), rd.nextInt(200), rd
                      .nextInt(200)));
              int x1 = rd.nextInt(WIDTH);
              int x2 = rd.nextInt(WIDTH);
              int y1 = rd.nextInt(HEIGHT);
              int y2 = rd.nextInt(HEIGHT);
              g.drawLine(x1, y1, x2, y2);
          }
  
          // 释放图形资源
          g.dispose();
          try {
              OutputStream os = response.getOutputStream();
  
              // 输出图像到页面
              ImageIO.write(image, "JPEG", os);
          } catch (IOException e) {
              e.printStackTrace();
          }
      }
  }
  
  ```


### 4.5 统一异常处理

系统对未登录异常、数据库操作异常以及程序未知异常进行了统一异常处理，具体实现步骤如下：

1. **创建未登录自定义异常**

创建未登录自定义异常NoLoginException，具体代码如下：

  ```java
  package com.example.networkdisk.exception;
  
  import java.io.Serial;
  
  /**
   * 未登录异常类
   */
  public class NoLoginException extends Exception {
      // 定义程序序列化ID,序列化ID，相当于身份认证.
      // 主要用于程序的版本控制，保持不同版本的兼容性，在程序版本升级时避免程序报出版本不一致的错误。
      @Serial
      private static final long serialVersionUID = 1L;
  
      public NoLoginException() {
          super();
      }
  
      public NoLoginException(String message) {
          super(message);
      }
  }
  
  ```



2. **创建统一异常处理类**

使用注释@ControllerAdvice和@ExceptionHandler创建统一异常处理类GlobalExceptionHandleController。使用注解@ControllerAdvice的类是一个增强的Controller类，在增强的控制器类中使用@ExceptionHandle注解的方法对所有控制器类进行统一异常处理。具体代码如下：

  ```java
  package com.example.networkdisk.controller;
  
  
  import com.example.networkdisk.exception.NoLoginException;
  import org.springframework.ui.Model;
  import org.springframework.web.bind.annotation.ControllerAdvice;
  import org.springframework.web.bind.annotation.ExceptionHandler;
  
  import java.sql.SQLException;
  
  /**
   * 统一处理异常类
   */
  // @controllerAdvice是一个增强的Controller
  // 可以实现三方面的功能：全局异常处理、全局数据绑定、全局数据预处理
  // 使用@controllerAdvice注解的类是当前Spring Boot应用中所有类的统一异常处理类
  // 该类中使用@ExceptionHandler注解的方法统一处理异常，不需要在每个Controller中逐一定义异常处理方法
  // 对所有注解了@RequestMapping的控制器方法有效
  @ControllerAdvice
  public class GlobalExceptionHandleController {
      // @ExceptionHandler(value = Exception.class)注解用来处理异常
      // 如果Controller中有一个使用@ExceptionHandler注解修饰的方法，那么当Controller的任何方法抛出异常时，都由该方法处理异常。
  
      /**
       * 全局异常处理方法
       */
      // @ExceptionHandler注解的方法统一处理异常
      @ExceptionHandler(value = Exception.class)
      public String exceptionHandler(Exception e, Model model) {
          String message;
          //数据库异常
          if (e instanceof SQLException) {
              message = "数据库异常";
          } else if (e instanceof NoLoginException) {
              message = "未登录异常";
          } else {//未知异常
              message = "未知异常";
          }
          model.addAttribute("errorMessage", message);
          return "error";
      }
  }
  
  ```

3. 创建myError.html

   在src/mian/resources/templates文件目录下创建error.html，代码如下：

   ```html
   <!DOCTYPE html>
   <html xmlns:th="http://www.thymeleaf.org" lang="en">
   ```

<head>
	    <meta charset="UTF-8">
	    <title>错误页面</title>
	    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
	</head>

	<body>
	<div class="panel panel-primary">
	    <div class="panel-heading">
	        <h3 class="panel-title">异常处理页面</h3>
	    </div>
	</div>
	<div class="container">
	    <div>
	        <h3>
	        <div th:text="${errorMessage}"></div></h3><br><br>
	        <a href="javascript:history.back()">返回</a>
	    </div>
	</div>
	</body>
	</html>
	```


​

### 4.6 工具类

本系统使用的工具类有一个：MyUtil

MyUtil的代码如下：

```java
package com.example.networkdisk.util;

import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * 自己定义的工具类
 */
public class MyUtil {
    /**
     * 将java.util.Date类型转换为java.sql.Timestamp类型
     * 对应MySQL中的datetime类型
     */
    public static Timestamp toTimeStamp(Date date) {
        // 将日期时间转换为数据库中的timestamp类型
        return new Timestamp(date.getTime());
    }

    /**
     * 将java.sql.Timestamp类型转换为java.util.Date类型
     * 将从MySQL中的datetime类型读出来的数据转换为java.util.Date类型
     */
    public static Date toDate(Timestamp timestamp) {

        return new Date(timestamp.getTime());
    }

    /**
     * 将java.util.Date转换为指定格式的String
     */
    public static String toString(Date date) {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        return sdf.format(date);
    }

    /**
     * 将Timestamp转换为指定格式的String
     * 用于数据库中字段类型为datetime
     */
    public static String toString(Timestamp timestamp) {
        return MyUtil.toString(MyUtil.toDate(timestamp));
    }

    /**
     * 将实际的文件名重命名
     */
    public static String getNewFileName(String oldFileName) {
        int lastIndex = oldFileName.lastIndexOf(".");
        String fileType = oldFileName.substring(lastIndex);
        Date now = new Date();
        SimpleDateFormat sdf = new SimpleDateFormat("YYYYMMDDHHmmssSSS");
        String time = sdf.format(now);
        return time + fileType;
    }
}

```